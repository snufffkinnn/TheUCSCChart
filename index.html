<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>The Web</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: Arial;
    }

    svg {
      width: 100vw;
      height: 100vh;
      display: block;
      cursor: grab;
    }

    svg:active {
      cursor: grabbing;
    }

    .ui {
      position: absolute;
      top: 15px;
      left: 15px;
      z-index: 10;
    }

    /* ===== Search ===== */

    .searchWrapper {
      position: relative;
      margin-bottom: 6px;
    }

    input {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 180px;
    }

    .suggestions {
      position: absolute;
      top: 32px;
      left: 0;
      background: white;
      border: 1px solid #ccc;
      border-radius: 4px;
      width: 180px;
      max-height: 160px;
      overflow-y: auto;
      display: none;
    }

    .suggestionItem {
      padding: 6px 8px;
      cursor: pointer;
    }

    .suggestionItem:hover {
      background: #eee;
    }

    button {
      margin-top: 5px;
      padding: 6px 10px;
      border: none;
      background: black;
      color: white;
      cursor: pointer;
      border-radius: 4px;
    }

    .title {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .minimap {
      position: absolute;
      bottom: 20px;
      right: 20px;
      width: 180px;
      height: 120px;
      border: 1px solid black;
      background: white;
    }

    /* ===== Tooltip ===== */

    .tooltip {
      position: absolute;
      padding: 6px 10px;
      background: rgba(0, 0, 0, 0.85);
      color: white;
      font-size: 12px;
      border-radius: 4px;
      pointer-events: none;
      opacity: 0;
    }
  </style>
</head>

<body>

  <div class="ui">
    <div class="title">The Web</div>

    <div class="searchWrapper">
      <input id="searchInput" placeholder="Search person..." />
      <div class="suggestions" id="suggestions"></div>
    </div>

    <button id="resetBtn">Reset View</button>
    <button id="fitBtn">Zoom To Fit</button>
    <button id="fullscreenBtn">Fullscreen</button>
  </div>

  <div class="tooltip"></div>

  <svg></svg>
  <svg class="minimap"></svg>

  <script>

    const svg = d3.select("svg");
    const minimapSVG = d3.select(".minimap");
    const tooltip = d3.select(".tooltip");

    const searchInput = d3.select("#searchInput");
    const suggestionsBox = d3.select("#suggestions");

    const width = window.innerWidth;
    const height = window.innerHeight;

    const container = svg.append("g");

    /* ===== Zoom ===== */

    const zoom = d3.zoom()
      .scaleExtent([0.2, 5])
      .on("zoom", (event) => {
        container.attr("transform", event.transform);
        updateMiniMap(event.transform);
      });

    svg.call(zoom);

    /* ===== Data URLs ===== */

    const nodesURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQo3L5ZgiotPgz8HEZssyrUAhkiGG4UswBy04LvtG6NUAjR823ep3qfSgeU_JWf7IHL6WgPwhNN5l-u/pub?gid=1961737593&single=true&output=csv";
    const edgesURL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQo3L5ZgiotPgz8HEZssyrUAhkiGG4UswBy04LvtG6NUAjR823ep3qfSgeU_JWf7IHL6WgPwhNN5l-u/pub?gid=884112586&single=true&output=csv";

    /* ===== Colors ===== */

    const colors = {
      Kissed: "green",
      Hookup: "red",
      Relationship: "blue",
      Situationship: "purple"
    };

    Promise.all([
      d3.csv(nodesURL),
      d3.csv(edgesURL)
    ]).then(([nodes, links]) => {

      let selectedNode = null;

      /* ===== Connection Lookup ===== */

      const linkedByIndex = {};

      links.forEach(d => {
        linkedByIndex[`${d.source},${d.target}`] = true;
        linkedByIndex[`${d.target},${d.source}`] = true;
      });

      function isConnected(a, b) {
        return linkedByIndex[`${a.id},${b.id}`] || a.id === b.id;
      }

      /* ===== Force Simulation ===== */

      const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-200))
        .force("center", d3.forceCenter(width / 2, height / 2));

      /* ===== Links ===== */

      const link = container.selectAll("line")
        .data(links)
        .enter()
        .append("line")
        .attr("stroke", d => colors[d.type])
        .attr("stroke-width", 2)
        .attr("opacity", 0.7)

        .on("mouseover", (event, d) => {

          d3.select(event.currentTarget).attr("stroke-width", 5);

          tooltip
            .style("opacity", 1)
            .html(`<strong>${d.type}</strong><br>${d.source.id} â†” ${d.target.id}`);
        })

        .on("mousemove", (event) => {
          tooltip
            .style("left", (event.pageX + 12) + "px")
            .style("top", (event.pageY + 12) + "px");
        })

        .on("mouseout", (event) => {
          d3.select(event.currentTarget).attr("stroke-width", 2);
          tooltip.style("opacity", 0);
        });

      /* ===== Nodes ===== */

      const node = container.selectAll("circle")
        .data(nodes)
        .enter()
        .append("circle")
        .attr("r", 8)
        .attr("fill", "black")
        .call(d3.drag().on("drag", dragged))
        .on("click", (event, d) => {
          event.stopPropagation();
          focusNode(d);
        });

      /* ===== Labels ===== */

      const label = container.selectAll("text")
        .data(nodes)
        .enter()
        .append("text")
        .text(d => d.id)
        .attr("font-size", 11)
        .attr("dx", 10)
        .attr("dy", 4);

      /* ===== Focus Node Helper ===== */

      function focusNode(found) {

        selectedNode = found;
        updateHighlight();

        const scale = 1.8;

        const transform = d3.zoomIdentity
          .translate(width / 2, height / 2)
          .scale(scale)
          .translate(-found.x, -found.y);

        svg.transition()
          .duration(700)
          .call(zoom.transform, transform);
      }

      /* ===== Search ===== */

      searchInput.on("input", function () {

        const query = this.value.toLowerCase();

        if (!query) {
          suggestionsBox.style("display", "none");
          return;
        }

        const matches = nodes.filter(n =>
          n.id.toLowerCase().includes(query)
        ).slice(0, 8);

        suggestionsBox
          .style("display", "block")
          .selectAll("div")
          .data(matches, d => d.id)
          .join(
            enter => enter.append("div")
              .attr("class", "suggestionItem")
              .text(d => d.id)
              .on("click", (event, d) => {
                searchInput.property("value", d.id);
                suggestionsBox.style("display", "none");
                focusNode(d);
              }),
            update => update.text(d => d.id),
            exit => exit.remove()
          );

      });

      /* Enter Key */
      searchInput.on("keydown", function (event) {
        if (event.key === "Enter") {
          const query = this.value.toLowerCase();
          const found = nodes.find(n => n.id.toLowerCase().includes(query));
          if (found) focusNode(found);
          suggestionsBox.style("display", "none");
        }
      });

      /* ===== Background Reset ===== */

      svg.on("click", () => {
        selectedNode = null;
        updateHighlight();
        searchInput.property("value", "");
        suggestionsBox.style("display", "none");
      });

      /* ===== Highlight Logic ===== */

      function updateHighlight() {

        if (!selectedNode) {

          node.style("opacity", 1).attr("r", 8);
          label.style("opacity", 1);
          link.style("opacity", 0.7).attr("stroke-width", 2);
          return;
        }

        node
          .style("opacity", d => isConnected(selectedNode, d) ? 1 : 0.1)
          .attr("r", d => d === selectedNode ? 14 : 8);

        label.style("opacity", d => isConnected(selectedNode, d) ? 1 : 0.1);

        link
          .style("opacity", d =>
            d.source.id === selectedNode.id ||
              d.target.id === selectedNode.id ? 1 : 0.05
          )
          .attr("stroke-width", d =>
            d.source.id === selectedNode.id ||
              d.target.id === selectedNode.id ? 4 : 1
          );
      }

      /* ===== Tick ===== */

      simulation.on("tick", () => {

        link
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y);

        node.attr("cx", d => d.x).attr("cy", d => d.y);
        label.attr("x", d => d.x).attr("y", d => d.y);

        drawMiniMap(nodes, links);
      });

      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }

      /* ===== Buttons ===== */

      d3.select("#resetBtn").on("click", () => {
        svg.transition().call(zoom.transform, d3.zoomIdentity);
      });

      d3.select("#fullscreenBtn").on("click", () => {
        if (!document.fullscreenElement) document.documentElement.requestFullscreen();
        else document.exitFullscreen();
      });

      /* ===== Mini Map ===== */

      function drawMiniMap(nodes, links) {

        minimapSVG.selectAll("*").remove();

        const scale = 0.15;

        const mini = minimapSVG.append("g")
          .attr("transform", `scale(${scale})`);

        mini.selectAll("line")
          .data(links)
          .enter()
          .append("line")
          .attr("x1", d => d.source.x)
          .attr("y1", d => d.source.y)
          .attr("x2", d => d.target.x)
          .attr("y2", d => d.target.y)
          .attr("stroke", "#aaa");

        mini.selectAll("circle")
          .data(nodes)
          .enter()
          .append("circle")
          .attr("cx", d => d.x)
          .attr("cy", d => d.y)
          .attr("r", 3)
          .attr("fill", "black");
      }

      function updateMiniMap(transform) {

        minimapSVG.selectAll("rect.viewport").remove();

        const scale = 0.15;

        minimapSVG.append("rect")
          .attr("class", "viewport")
          .attr("x", -transform.x * scale / transform.k)
          .attr("y", -transform.y * scale / transform.k)
          .attr("width", width * scale / transform.k)
          .attr("height", height * scale / transform.k)
          .attr("fill", "none")
          .attr("stroke", "red");
      }

    });

  </script>
</body>

</html>

<!-- trying to get github pages to deploy -->